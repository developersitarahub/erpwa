generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Vendor {
  id                    String         @id @default(uuid())
  name                  String
  whatsappBusinessId    String?
  whatsappPhoneNumberId String?
  whatsappAccessToken   String?
  whatsappStatus        String         @default("not_configured")
  whatsappVerifiedAt    DateTime?
  whatsappLastError     String?
  // WhatsApp Flows Encryption Keys
  whatsappFlowsPublicKey String?  // Stores the Public Key (PEM format)
  whatsappFlowsPrivateKey String? // Encrypted Private Key
  createdAt             DateTime       @default(now())
  campaigns             Campaign[]
  categories            Category[]
  contacts              Contact[]
  conversations         Conversation[]
  galleryImages         GalleryImage[]
  leads                 Lead[]
  mediaAlbums           MediaAlbum[]
  messages              Message[]
  templates             Template[]
  users                 User[]
  activityLogs          ActivityLog[]
  workflows             Workflow[]
  whatsappFlows         WhatsAppFlow[]
}


model User {
  id                String             @id @default(uuid())
  vendorId          String?
  name              String
  email             String             @unique
  passwordHash      String
  role              UserRole
  status            String             @default("active") // active, inactive
  isOnline          Boolean            @default(false)
  lastLoginAt       DateTime?
  activatedAt       DateTime?          // When user first set password via invite link
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  messages          Message[]          @relation("UserMessages")
  passwordResetOtps PasswordResetOtp[]
  refreshTokens     RefreshToken[]
  vendor            Vendor?            @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetOtp {
  id        String   @id @default(uuid())
  userId    String
  otpHash   String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}


model Lead {
  id              String         @id @default(uuid())
  vendorId        String
  phoneNumber     String
  status          String         @default("new")

  whatsappOptIn   Boolean        @default(true)
  optInSource     String?
  optInMessage    String?
  optInAt         DateTime?
  blockedAt       DateTime?
  lastContactedAt DateTime?

  city            String?
  companyName     String?
  email           String?
  salesPersonId   String?
  salesPersonName String?

  categoryId      Int?
  subCategoryId   Int?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  conversations   Conversation[]

  leadCategory    Category? @relation("LeadCategory", fields: [categoryId], references: [id])
  leadSubCategory Category? @relation("LeadSubCategory", fields: [subCategoryId], references: [id])

  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, phoneNumber])
  @@index([email])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([status])
}


model Category {
  id             Int            @id @default(autoincrement())
  vendorId       String
  name           String
  parentId       Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Self relation (tree)
  parent         Category?      @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children       Category[]     @relation("CategoryTree")

  vendor         Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  // Leads
  leads          Lead[]         @relation("LeadCategory")
  leadSubcats    Lead[]         @relation("LeadSubCategory")

  // Contacts
  contacts       Contact[]      @relation("ContactCategory")
  contactSubcats Contact[]      @relation("ContactSubCategory")

  // Gallery
  galleryImages  GalleryImage[] @relation("GalleryCategory")
  gallerySubcats GalleryImage[] @relation("GallerySubCategory")

  @@unique([vendorId, name, parentId])
  @@index([vendorId])
  @@index([parentId])
}


model Contact {
  id              Int       @id @default(autoincrement())
  vendorId        String
  companyName     String
  mobileNumber    String
  categoryId      Int?
  subCategoryId   Int?
  salesPersonName String?
  status          String    @default("pending")
  assignedTo      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  category        Category? @relation("ContactCategory", fields: [categoryId], references: [id])
  subCategory     Category? @relation("ContactSubCategory", fields: [subCategoryId], references: [id])
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, mobileNumber])
  @@index([vendorId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([status])
}

model GalleryImage {
  id            Int       @id @default(autoincrement())
  vendorId      String
  categoryId    Int?
  subCategoryId Int?
  title         String?
  description   String?
  s3Url         String
  s3Key         String?
  price         Float?
  priceCurrency String?   @default("USD")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  category      Category? @relation("GalleryCategory", fields: [categoryId], references: [id])
  subCategory   Category? @relation("GallerySubCategory", fields: [subCategoryId], references: [id])
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([categoryId])
  @@index([subCategoryId])
}

model Conversation {
  id               String    @id @default(uuid())
  vendorId         String
  leadId           String
  channel          String    @default("whatsapp")
  lastMessageAt    DateTime?
  isOpen           Boolean   @default(true)
  sessionStartedAt DateTime?
  sessionExpiresAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  lead             Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  vendor           Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  messages         Message[]
  flowResponses    FlowResponse[]

  @@unique([vendorId, leadId])
}

model Template {
  id               String             @id @default(uuid())
  vendorId         String
  metaTemplateName String
  displayName      String
  category         String
  status           String             @default("draft")
  templateType     String             @default("standard") // standard, catalog, carousel
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  campaigns        Campaign[]
  vendor           Vendor             @relation(fields: [vendorId], references: [id])
  buttons          TemplateButton[]
  languages        TemplateLanguage[]
  media            TemplateMedia[]
  catalogProducts  TemplateCatalogProduct[] // For multi-product catalog templates
  carouselCards    TemplateCarouselCard[]   // For carousel templates

  createdBy        String?            // User ID who created this template
  
  // Flow support
  flowId           String?
  flow             WhatsAppFlow?      @relation(fields: [flowId], references: [id], onDelete: SetNull)

  @@unique([vendorId, metaTemplateName])
  @@index([vendorId])
  @@index([createdBy])
  @@index([flowId])

}

// Carousel Template Support (Multi-Card)
model TemplateCarouselCard {
  id           String   @id @default(uuid())
  templateId   String
  title        String
  subtitle     String?
  
  // Image is required for Carousel cards
  s3Url        String?  // S3 URL of uploaded image
  mediaHandle  String?  // Meta Media Handle (after upload)
  mimeType     String?
  
  // Button (1 per card supported in UI)
  buttonType   String?  @default("URL") 
  buttonText   String?
  buttonValue  String?  // URL

  position     Int      // Order position (0-9)
  createdAt    DateTime @default(now())
  
  template     Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, position])
  @@index([templateId])
}

model TemplateButton {
  id         String   @id @default(uuid())
  templateId String
  type       String
  text       String
  value      String?
  position   Int
  
  // Flow button support
  flowId     String?  // Reference to WhatsAppFlow if type is FLOW
  flowAction String?  // 'navigate' or 'data_exchange'
  
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, position])
}
model TemplateMedia {
  id              String    @id @default(uuid())
  templateId      String
  language        String
  position        Int       @default(0)
  mediaType       String
  s3Url           String
  mimeType        String
  whatsappMediaId String?
  uploadStatus    String    @default("pending")
  uploadError     String?
  uploadedAt      DateTime?
  template        Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, language, position])
}

model TemplateLanguage {
  id               String   @id @default(uuid())
  templateId       String
  language         String
  body             String
  footerText       String?
  headerType       String?
  headerText       String?
  headerExampleUrl String?
  headerFilename   String?
  metaStatus       String   @default("draft")
  metaReason       String?
  metaId           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  template         Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, language])
}

// Multi-Product Catalog Template Support
// WhatsApp allows up to 30 products per catalog message
model TemplateCatalogProduct {
  id           String   @id @default(uuid())
  templateId   String
  productId    String   // Product ID from WhatsApp Business Catalog
  position     Int      // Order position (0-29, max 30 products)
  createdAt    DateTime @default(now())
  template     Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, position])
  @@index([templateId])
}
enum CampaignType {
  TEMPLATE
  IMAGE
}

enum ImageCaptionMode {
  NONE
  TITLE
  DESCRIPTION
  FULL
}

model Campaign {
  id            String        @id @default(uuid())
  vendorId      String

  type          CampaignType

  // ✅ ADD THIS
  templateId    String?
  template      Template?     @relation(fields: [templateId], references: [id])

  categoryId    Int?
  subCategoryId Int?
  imageLimit    Int?          @default(100)
  captionMode   ImageCaptionMode?

  name          String?
  filters       Json?

  // ✅ Campaign execution tracking
  totalMessages  Int          @default(0)
  sentMessages   Int          @default(0)
  failedMessages Int          @default(0)

  startedAt     DateTime?
  completedAt   DateTime?

  status        String        @default("draft")
  scheduledAt   DateTime?
  createdBy     String?       // User ID who created this campaign
  createdAt     DateTime      @default(now())

  vendor        Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@index([vendorId])
  @@index([type])
  @@index([createdBy])
}



model Message {
  id                String            @id @default(uuid())
  vendorId          String
  conversationId    String
  campaignId        String?
  senderId          String?
  albumId           String?

  direction         String
  channel           String            @default("whatsapp")
  messageType       String?
  content           String?
  inboundPayload    Json?
  outboundPayload   Json?
  whatsappMessageId String?
  replyToMessageId  String?
  status            String?
  errorCode         String?

  retryCount        Int               @default(0)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  // ✅ RELATIONS (EXPLICIT & CORRECT)
  vendor        Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  conversation  Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  campaign      Campaign?     @relation(fields: [campaignId], references: [id])
  sender        User?         @relation("UserMessages", fields: [senderId], references: [id])
  album         MediaAlbum?   @relation(fields: [albumId], references: [id])

  media         MessageMedia[]
  deliveries    MessageDelivery[]
}


model MediaAlbum {
  id        String       @id @default(uuid())
  vendorId  String
  name      String?
  createdAt DateTime     @default(now())
  vendor    Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  assets    MediaAsset[]
  messages  Message[]
}

model MediaAsset {
  id        String      @id @default(uuid())
  albumId   String?
  mediaType MediaType
  mimeType  String
  mediaUrl  String
  caption   String?
  createdAt DateTime    @default(now())
  album     MediaAlbum? @relation(fields: [albumId], references: [id], onDelete: Cascade)
}

model MessageMedia {
  id         String            @id @default(uuid())
  messageId  String
  mediaType  MediaType
  mimeType   String
  mediaUrl   String
  caption    String?
  fileName   String?
  assetId    String?
  createdAt  DateTime          @default(now())
  deliveries MessageDelivery[]
  message    Message           @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model MessageDelivery {
  id             String       @id @default(uuid())
  messageId      String
  messageMediaId String
  conversationId String
  whatsappMsgId  String?
  status         String
  error          String?
  createdAt      DateTime     @default(now())
  message        Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageMedia   MessageMedia @relation(fields: [messageMediaId], references: [id], onDelete: Cascade)

  @@unique([messageMediaId, conversationId])
}

enum UserRole {
  vendor_owner
  owner
  vendor_admin
  sales
}

enum MediaType {
  image
  video
  audio
  document
  sticker
}
model ActivityLog {
  id              String   @id @default(uuid())
  vendorId        String?
  conversationId  String?
  messageId       String?  // WhatsApp message ID
  phoneNumber     String?
  type            String   // Message type or "webhook"
  status          String   // read, delivered, failed, template_approved, approved, received, success, error, ignored
  event           String?  // Operation name (send, receive, delivery_update, template_approval, verification, etc.)
  category        String?  // Category from payload
  error           String?  // Only populated if there's an actual error
  payload         Json?    // Full payload for reference
  
  // Webhook specific fields
  direction       String?  // "inbound" | "outbound_status"
  responseCode    Int?     // HTTP response code
  processingMs    Int?     // Processing time in ms

  // New filtering fields
  whatsappBusinessId    String?
  whatsappPhoneNumberId String?

  createdAt       DateTime @default(now())
  
  vendor          Vendor?  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  @@index([vendorId])
  @@index([conversationId])
  @@index([messageId])
  @@index([status])
  @@index([createdAt])
  @@index([type])
  @@index([whatsappBusinessId])
  @@index([whatsappPhoneNumberId])
}

model Workflow {
  id          String   @id @default(uuid())
  vendorId    String
  name        String
  description String?
  isActive    Boolean  @default(false)
  triggerKeyword String? // Keyword to start this flow
  nodes       Json     // Store reactflow nodes
  edges       Json     // Store reactflow edges
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  sessions    WorkflowSession[]
  
  @@unique([vendorId, triggerKeyword])
}

model WorkflowSession {
  id            String   @id @default(uuid())
  workflowId    String
  conversationId String // Link to the Conversation
  currentNodeId String   // ID of the node the user is currently at
  state         Json?    // Store variables collected during flow
  status        String   @default("active") // active, completed, dropped
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workflow      Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

// WhatsApp Flows - Interactive structured experiences
model WhatsAppFlow {
  id                String   @id @default(uuid())
  metaFlowId        String   @unique  // Meta's Flow ID (from Graph API)
  name              String
  category          String   // lead_generation, appointment_booking, sign_up, sign_in, customer_support, etc.
  status            String   @default("DRAFT") // DRAFT, PUBLISHED, DEPRECATED
  
  flowJson          Json     // Flow JSON definition (screens, components, routing)
  endpointUri       String?  // Optional data exchange endpoint URL
  
  vendorId          String
  vendor            Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  publishedAt       DateTime?
  deprecatedAt      DateTime?
  
  // Relations
  templates         Template[]  // Templates that use this Flow
  responses         FlowResponse[]
  
  @@index([vendorId])
  @@index([metaFlowId])
  @@index([status])
}

// Flow Responses - Track user submissions from Flows
model FlowResponse {
  id                String   @id @default(uuid())
  flowId            String?
  flow              WhatsAppFlow? @relation(fields: [flowId], references: [id], onDelete: SetNull)
  
  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  responseData      Json     // User's Flow submission data
  flowToken         String?  // Flow token for tracking session
  status            String   // completed, abandoned, in_progress
  
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  
  @@index([flowId])
  @@index([conversationId])
  @@index([flowToken])
  @@index([status])
}